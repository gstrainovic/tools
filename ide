#!/bin/bash
# ide [dir] - WezTerm Layout: yazi 30% links + nvim 70% rechts
# Dateien öffnen sich in nvim via nvim-ide-open
# Bilder/PDFs in nvim lösen ya emit-to aus → yazi zeigt Preview
# Funktioniert unter Linux und Windows (Git Bash)

DIR="${1:-$PWD}"
DIR="$(realpath "$DIR")"

# Feste Client-ID (muss eine Zahl sein) damit nvim per ya emit-to kommunizieren kann
export YAZI_IDE_ID="1313"

# Socket-Pfad: Unix-Socket (Linux) oder Named Pipe (Windows)
if [[ "$OS" == "Windows_NT" ]]; then
    SOCKET='\\.\pipe\nvim-ide'
else
    SOCKET="/tmp/nvim-ide.sock"
    rm -f "$SOCKET"
fi

if [ -z "$WEZTERM_PANE" ]; then
    # Nicht in WezTerm → neues Fenster öffnen das dieses Script ausführt
    exec wezterm start --cwd "$DIR" -- bash -l -c "ide '$DIR'"
fi

# Bereits in WezTerm → Layout erstellen

# Rechts (70%) → nvim als Server
wezterm cli split-pane --right --percent 70 --cwd "$DIR" -- \
    bash -l -c "cd '$DIR' && YAZI_IDE_ID=$YAZI_IDE_ID nvim --listen '$SOCKET'"

# Warte bis nvim-Server bereit ist (max 10s)
for i in $(seq 100); do
    nvim --server "$SOCKET" --remote-expr "1" &>/dev/null && break
    sleep 0.1
done

if ! nvim --server "$SOCKET" --remote-expr "1" &>/dev/null; then
    echo "FEHLER: nvim-Server nicht bereit nach 10s" >&2
    exit 1
fi

# Linkes Pane (30%) → yazi mit fester Client-ID
exec yazi "$DIR" --client-id "$YAZI_IDE_ID"
